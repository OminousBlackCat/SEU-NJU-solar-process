# 全日面太阳图像解析与预处理
本程序实质上是[预处理模块仓库](https://github.com/OminousBlackCat/NJU_SEU_sun_data_process)与[帧解析模块仓库](https://github.com/OminousBlackCat/SEU-NJU-DataProcess)的合并，合并仍在进行中，具体代码请至上述两个仓库内查看。

## 主要需求

卫星直接拍摄获得原始数据帧(.dat)格式，从帧内抽取**JPEG2000**格式的卫星原图像，并对图像进行预处理最后得到完整的全日面太阳光谱图。

| 程序参数 | 内容                                              |
| -------- | ------------------------------------------------- |
| 程序输入 | 单个.dat格式的二进制帧源文件                      |
| 中间输出 | 多个fits.格式的单狭缝光谱图                       |
| 程序输出 | 多个无损观测序列组成的全日面光谱图(多个.fits文件) |
| 运行环境 | Linux(Centos 7), 80个逻辑核心, 高内存场景         |
| 使用语言 | Python                                            |

## 并行实现

由于对速度有较高需求，程序使用Python自带多核并行库[multiprocessing](https://docs.python.org/3/library/multiprocessing.html)进行并行化设计。

在Linux环境内，主程序开辟一块共享内存空间保存共享参数，之后multiprocess会调度进程池并调用fork()开启多个子程序执行帧解析操作，此进程池作为生产者-消费者模型中的生产者，将帧解析结果存在共享全局数组中。而同时会有固定数量的消费者进程同时开启来对生产者模型的输出进行写盘操作（此处可以写入逻辑磁盘，例：内存文件系统，来加快写入速度）。

再之后程序对上一步生成的帧解析结果进行排序，并将其分组为多个观测序列，之后会再次调度新的进程池并fork()开启多个子程序来对每个观测序列进行预处理操作，每个观测序列都可以生成一套完整的全日面光谱图，对应一个观测时刻。

## 使用的第三方库

* Numpy

* astropy

* opencv

* openjpeg

## 外部参数

修改外部参数请编辑**config.py**，参数具体格式可参考内部注释，下表列出了其中的重要参数：
| 参数                 | 说明                                                  | 默认值               |
| -------------------- | ----------------------------------------------------- | -------------------- |
| multiprocess_count   | 处理进程与读取进程的数量(单位: 进程个数)              | 60                   |
| input_file_url       | 输入的tar文件的所在位置                               | -                    |
| output_dir           | 输出的Lev0文件目录                                    | -                    |
| temp_extract_dir     | 解压的临时dat文件目录(程序结束后会清空该临时文件)     | ./temp/              |
| output_csv_dir       | 输出的csv文件目标地址                                 | -                    |
| writer_process_count | 写入进程数量(单位: 进程个数)                          | 20                   |
| iteration_chunk_size | 处理进程与读取进程每次读取的文件chunk大小(单位: Byte) | 10\*1024\*1024(10MB) |

## 外部依赖文件
程序运行时依赖一些外部文件, 具体功能如下表所示。

| 文件名         | 说明                                                         | 备注                                                         |
| -------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| for_flat.fits          | binning=1对应的平场文件                            |                                                              |
| for_flat_binning2.fits | binning=2对应的平场文件                            |                                                              |
| dark.fits              | 暗场文件                                           |                                                              |
| HA_absorption.txt      | HA窗口吸收系数文件                                 |                                                              |
| FE_absorption.txt      | FE窗口吸收系数文件                                 |                                                              |
| color_map.txt          | 绘制png日像时使用的色表文件                        |                                                              |
| header.txt             | 标准头部参数文件                                   | 修改header内部的键(key)与评论(comment)可以直接体现在最后生成的文件内 |
| de430.bsp              | 计算B0等值时使用的星表文件(此文件在不同的文件夹内) | 此文件夹使用绝对路径索引                                     |
| raw_header.txt | 该文件包含了一个标准Lev0 fits文件包含的头部数据, 程序会读入此txt并按此txt的值当做header的默认值。header中有部分参数根据读取的实际文件获得，其他参数均基于此txt文件。 | 修改一些默认header内部的参数或参数名称可以直接体现在Lev0数据内，也可以直接添加header参数与其的默认值。 |
| all_header.txt | 该文件名包含了csv中表头各项参数的名称，其并不会对程序内部解析帧过程造成任何影响，仅仅只是写入csv时需要用到。 | 修改此文件可以直接体现在输出的csv文件上。                    |
